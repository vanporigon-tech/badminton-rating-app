<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè∏ MVP –¢–µ—Å—Ç - –°–∏—Å—Ç–µ–º–∞ —Ç—É—Ä–Ω–∏—Ä–æ–≤</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            border: 2px solid rgba(255,255,255,0.2);
        }
        .test-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .success { color: #51cf66; }
        .error { color: #ff6b6b; }
        .info { color: #74c0fc; }
        .warning { color: #ffd43b; }
        .log {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .room {
            border: 2px solid rgba(255,255,255,0.3);
            margin: 15px 0;
            padding: 20px;
            border-radius: 15px;
            background: rgba(255,255,255,0.1);
        }
        .room-name {
            font-weight: bold;
            font-size: 20px;
            color: #fff;
            margin-bottom: 10px;
        }
        .room-info {
            color: rgba(255,255,255,0.8);
            margin: 5px 0;
        }
        .member {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            margin: 5px;
            border-radius: 20px;
            font-size: 14px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        .leader {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            font-weight: bold;
        }
        h1 {
            text-align: center;
            font-size: 36px;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        h2 {
            color: #ffd700;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè∏ MVP –¢–µ—Å—Ç - –°–∏—Å—Ç–µ–º–∞ —Ç—É—Ä–Ω–∏—Ä–æ–≤</h1>
        
        <div class="test-section">
            <h2>üîß –¢–µ—Å—Ç API</h2>
            <button class="test-button" onclick="testAPI()">üåê –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–Ω–∞—Ç</button>
            <button class="test-button" onclick="testTournamentAPI()">üèÜ –¢–µ—Å—Ç —Ç—É—Ä–Ω–∏—Ä API</button>
            <div id="api-log" class="log"></div>
        </div>
        
        <div class="test-section">
            <h2>üè† –¢–µ—Å—Ç –∫–æ–º–Ω–∞—Ç</h2>
            <button class="test-button" onclick="createTestRoom()">‚ûï –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É</button>
            <button class="test-button" onclick="loadRooms()">üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–Ω–∞—Ç—ã</button>
            <div id="rooms-display"></div>
        </div>
        
        <div class="test-section">
            <h2>üèÜ –¢–µ—Å—Ç —Ç—É—Ä–Ω–∏—Ä–æ–≤</h2>
            <button class="test-button" onclick="startTestTournament()">üèÜ –ù–∞—á–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä</button>
            <button class="test-button" onclick="endTestTournament()">üèÅ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä</button>
            <button class="test-button" onclick="showTournamentStats()">üìä –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
            <div id="tournament-log" class="log"></div>
        </div>
        
        <div class="test-section">
            <h2>üéÆ –¢–µ—Å—Ç –∏–≥—Ä—ã</h2>
            <button class="test-button" onclick="simulateGame()">üéÆ –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä—É</button>
            <button class="test-button" onclick="testGlicko2()">üìä –¢–µ—Å—Ç Glicko-2</button>
            <div id="game-log" class="log"></div>
        </div>
        
        <div class="test-section">
            <h2>üì± –¢–µ—Å—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞</h2>
            <button class="test-button" onclick="openMainApp()">üöÄ –û—Ç–∫—Ä—ã—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
            <div id="frontend-log" class="log"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://vanporigon-tech.github.io/badminton-rating-app';
        
        function log(message, type = 'info', target = 'api-log') {
            const logDiv = document.getElementById(target);
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logDiv.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        async function testAPI() {
            log('üåê –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∫–æ–º–Ω–∞—Ç...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/rooms.json`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const rooms = await response.json();
                log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${rooms.length} –∫–æ–º–Ω–∞—Ç`, 'success');
                
                rooms.forEach(room => {
                    log(`- ${room.name} (ID: ${room.id}, —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${room.member_count})`, 'info');
                });
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        
        async function testTournamentAPI() {
            log('üèÜ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ç—É—Ä–Ω–∏—Ä API...', 'info');
            
            try {
                // –¢–µ—Å—Ç –Ω–∞—á–∞–ª–∞ —Ç—É—Ä–Ω–∏—Ä–∞
                const startResponse = await fetch(`${API_BASE_URL}/api/tournament/start.json`);
                if (startResponse.ok) {
                    const startData = await startResponse.json();
                    log(`‚úÖ –ù–∞—á–∞–ª–æ —Ç—É—Ä–Ω–∏—Ä–∞: ${startData.message}`, 'success');
                }
                
                // –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞
                const endResponse = await fetch(`${API_BASE_URL}/api/tournament/end.json`);
                if (endResponse.ok) {
                    const endData = await endResponse.json();
                    log(`‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞: ${endData.message}`, 'success');
                }
                
                // –¢–µ—Å—Ç –¥–∞–Ω–Ω—ã—Ö —Ç—É—Ä–Ω–∏—Ä–∞
                const dataResponse = await fetch(`${API_BASE_URL}/api/tournament/1.json`);
                if (dataResponse.ok) {
                    const data = await dataResponse.json();
                    log(`‚úÖ –î–∞–Ω–Ω—ã–µ —Ç—É—Ä–Ω–∏—Ä–∞: ${data.message}`, 'success');
                }
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Ç—É—Ä–Ω–∏—Ä API: ${error.message}`, 'error');
            }
        }
        
        function createTestRoom() {
            log('‚ûï –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É...', 'info');
            
            const roomData = {
                id: Date.now(),
                name: `–¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞ ${new Date().toLocaleTimeString()}`,
                creator_id: Math.floor(Math.random() * 1000000),
                creator_full_name: "–¢–µ—Å—Ç–æ–≤—ã–π –∏–≥—Ä–æ–∫",
                max_players: 4,
                member_count: 1,
                is_active: true,
                created_at: new Date().toISOString(),
                members: [{
                    id: 1,
                    player: {
                        id: Math.floor(Math.random() * 1000000),
                        telegram_id: Math.floor(Math.random() * 1000000),
                        first_name: "–¢–µ—Å—Ç–æ–≤—ã–π",
                        last_name: "–ò–≥—Ä–æ–∫",
                        username: "test_player",
                        rating: 1500
                    },
                    is_leader: true,
                    joined_at: new Date().toISOString()
                }]
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            const existingRooms = JSON.parse(localStorage.getItem('badminton_local_rooms') || '[]');
            existingRooms.push(roomData);
            localStorage.setItem('badminton_local_rooms', JSON.stringify(existingRooms));
            
            log(`‚úÖ –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞: ${roomData.name}`, 'success');
            loadRooms();
        }
        
        function loadRooms() {
            log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–Ω–∞—Ç—ã...', 'info');
            
            const staticRooms = JSON.parse(localStorage.getItem('badminton_static_rooms') || '[]');
            const localRooms = JSON.parse(localStorage.getItem('badminton_local_rooms') || '[]');
            
            const allRooms = [...staticRooms, ...localRooms];
            
            const roomsDisplay = document.getElementById('rooms-display');
            
            if (allRooms.length === 0) {
                roomsDisplay.innerHTML = '<p>–ù–µ—Ç –∫–æ–º–Ω–∞—Ç</p>';
                return;
            }
            
            const roomsHtml = allRooms.map(room => {
                const membersHtml = room.members.map(member => {
                    const player = member.player;
                    const name = `${player.first_name} ${player.last_name}`.trim();
                    const leaderClass = member.is_leader ? 'leader' : '';
                    return `<span class="member ${leaderClass}">${member.is_leader ? 'üëë ' : ''}${name}</span>`;
                }).join('');
                
                return `
                    <div class="room">
                        <div class="room-name">${room.name}</div>
                        <div class="room-info">ID: ${room.id} | –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${room.member_count}/${room.max_players}</div>
                        <div class="room-info">–°–æ–∑–¥–∞—Ç–µ–ª—å: ${room.creator_full_name}</div>
                        <div>${membersHtml}</div>
                    </div>
                `;
            }).join('');
            
            roomsDisplay.innerHTML = roomsHtml;
            log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allRooms.length} –∫–æ–º–Ω–∞—Ç`, 'success');
        }
        
        function startTestTournament() {
            log('üèÜ –ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ç—É—Ä–Ω–∏—Ä...', 'info');
            
            const tournamentId = Date.now();
            const tournamentInfo = {
                id: tournamentId,
                status: 'active',
                start_time: new Date().toISOString(),
                games: []
            };
            
            localStorage.setItem('current_tournament_id', tournamentId);
            localStorage.setItem(`tournament_${tournamentId}`, JSON.stringify(tournamentInfo));
            localStorage.setItem(`tournament_${tournamentId}_games`, JSON.stringify([]));
            
            log(`‚úÖ –¢—É—Ä–Ω–∏—Ä #${tournamentId} –Ω–∞—á–∞—Ç!`, 'success');
        }
        
        function endTestTournament() {
            log('üèÅ –ó–∞–≤–µ—Ä—à–∞–µ–º —Ç—É—Ä–Ω–∏—Ä...', 'info');
            
            const tournamentId = localStorage.getItem('current_tournament_id');
            if (!tournamentId) {
                log('‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç—É—Ä–Ω–∏—Ä–∞', 'error');
                return;
            }
            
            const tournamentInfo = JSON.parse(localStorage.getItem(`tournament_${tournamentId}`) || '{}');
            tournamentInfo.status = 'finished';
            tournamentInfo.end_time = new Date().toISOString();
            
            localStorage.setItem(`tournament_${tournamentId}`, JSON.stringify(tournamentInfo));
            localStorage.removeItem('current_tournament_id');
            
            const games = JSON.parse(localStorage.getItem(`tournament_${tournamentId}_games`) || '[]');
            
            log(`‚úÖ –¢—É—Ä–Ω–∏—Ä #${tournamentId} –∑–∞–≤–µ—Ä—à–µ–Ω! –ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ: ${games.length}`, 'success');
        }
        
        function showTournamentStats() {
            log('üìä –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç—É—Ä–Ω–∏—Ä–æ–≤...', 'info');
            
            const tournaments = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('tournament_') && !key.includes('_games')) {
                    const tournamentId = key.replace('tournament_', '');
                    const tournament = JSON.parse(localStorage.getItem(key) || '{}');
                    const games = JSON.parse(localStorage.getItem(`tournament_${tournamentId}_games`) || '[]');
                    tournaments.push({ id: tournamentId, ...tournament, games });
                }
            }
            
            if (tournaments.length === 0) {
                log('‚ùå –¢—É—Ä–Ω–∏—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'warning');
                return;
            }
            
            tournaments.forEach(tournament => {
                log(`üèÜ –¢—É—Ä–Ω–∏—Ä #${tournament.id}: ${tournament.status}, –∏–≥—Ä: ${tournament.games.length}`, 'info');
            });
        }
        
        function simulateGame() {
            log('üéÆ –°–∏–º—É–ª–∏—Ä—É–µ–º –∏–≥—Ä—É...', 'info');
            
            const tournamentId = localStorage.getItem('current_tournament_id');
            if (!tournamentId) {
                log('‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç—É—Ä–Ω–∏—Ä–∞', 'error');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã
            const gameData = {
                room_id: Date.now(),
                team1: [Math.floor(Math.random() * 1000000)],
                team2: [Math.floor(Math.random() * 1000000)],
                score1: Math.floor(Math.random() * 21) + 1,
                score2: Math.floor(Math.random() * 21) + 1,
                rating_changes: {
                    [Math.floor(Math.random() * 1000000)]: {
                        player_id: Math.floor(Math.random() * 1000000),
                        old_rating: 1500,
                        new_rating: 1500 + (Math.random() - 0.5) * 100,
                        rating_change: (Math.random() - 0.5) * 100,
                        team: 'team1',
                        won: Math.random() > 0.5
                    }
                },
                timestamp: new Date().toISOString()
            };
            
            const tournamentGames = JSON.parse(localStorage.getItem(`tournament_${tournamentId}_games`) || '[]');
            tournamentGames.push(gameData);
            localStorage.setItem(`tournament_${tournamentId}_games`, JSON.stringify(tournamentGames));
            
            log(`‚úÖ –ò–≥—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞: ${gameData.score1}:${gameData.score2}`, 'success');
        }
        
        function testGlicko2() {
            log('üìä –¢–µ—Å—Ç–∏—Ä—É–µ–º Glicko-2...', 'info');
            
            // –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç Glicko-2
            const oldRating = 1500;
            const oldRd = 350;
            const opponentRating = 1600;
            const opponentRd = 350;
            const score = 1; // –ü–æ–±–µ–¥–∞
            
            const g = 1 / Math.sqrt(1 + 3 * (opponentRd ** 2) / (Math.PI ** 2));
            const e = 1 / (1 + Math.exp(-g * (oldRating - opponentRating) / 400));
            const v = 1 / (g ** 2 * e * (1 - e));
            const newRating = oldRating + (oldRd ** 2 + v) * g * (score - e);
            const newRd = Math.sqrt(1 / (1 / (oldRd ** 2) + 1 / v));
            
            log(`–°—Ç–∞—Ä—ã–π —Ä–µ–π—Ç–∏–Ω–≥: ${oldRating.toFixed(0)}`, 'info');
            log(`–ù–æ–≤—ã–π —Ä–µ–π—Ç–∏–Ω–≥: ${newRating.toFixed(0)}`, 'success');
            log(`–ò–∑–º–µ–Ω–µ–Ω–∏–µ: ${(newRating - oldRating).toFixed(0)}`, 'info');
            log(`–ù–æ–≤–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ: ${newRd.toFixed(0)}`, 'info');
        }
        
        function openMainApp() {
            log('üöÄ –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...', 'info');
            window.open('index.html', '_blank');
        }
        
        // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        window.addEventListener('load', () => {
            log('üöÄ MVP –¢–µ—Å—Ç –∑–∞–ø—É—â–µ–Ω', 'success');
            loadRooms();
        });
    </script>
</body>
</html>
